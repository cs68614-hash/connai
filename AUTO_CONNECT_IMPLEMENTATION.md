# ConnAI è‡ªåŠ¨è¿æ¥åŠŸèƒ½å®ç°æ€»ç»“

## é—®é¢˜æè¿°
ç”¨æˆ·æŠ¥å‘Šæµè§ˆå™¨æ’ä»¶æ‰§è¡Œæ“ä½œæ—¶å‡ºç°é”™è¯¯ï¼š"Failed to connect to VS Code. Please ensure VS Code extension is running."ï¼Œéœ€è¦å®ç°è‡ªåŠ¨è¿æ¥åŠŸèƒ½ï¼Œé¿å…æ‰‹åŠ¨å¤„ç†ã€‚

## è§£å†³æ–¹æ¡ˆ

### 1. ç«¯å£é…ç½®ç»Ÿä¸€
**é—®é¢˜**ï¼šæµè§ˆå™¨æ’ä»¶é»˜è®¤ç«¯å£ 3000 ä¸ VS Code æ‰©å±•ç«¯å£ä¸åŒ¹é…
- VS Code å·¥ä½œåŒºç®¡ç†å™¨ï¼š6718 + åç§»ï¼ˆ0-99ï¼‰
- åè®®æœåŠ¡å™¨ï¼š8080

**è§£å†³**ï¼š
- æ›´æ–°æµè§ˆå™¨æ’ä»¶é»˜è®¤ç«¯å£ä¸º 6797
- æ›´æ–° WebSocket å®¢æˆ·ç«¯é»˜è®¤ç«¯å£
- ç»Ÿä¸€é…ç½®æ–‡ä»¶ä¸­çš„ç«¯å£è®¾ç½®

### 2. è‡ªåŠ¨è¿æ¥æœºåˆ¶å®ç°

#### Background Script è‡ªåŠ¨è¿æ¥
```typescript
// å¯åŠ¨æ—¶è‡ªåŠ¨è¿æ¥ï¼ˆ2ç§’åï¼‰
setTimeout(autoConnect, 2000);

// è‡ªåŠ¨ç«¯å£æ£€æµ‹
const detectedServer = await findConnAIServer(config.serverUrl);
if (detectedServer) {
  config.port = detectedServer.port;
  // è‡ªåŠ¨è¿æ¥
}
```

#### å®šæœŸå¥åº·æ£€æŸ¥å’Œé‡è¿
```typescript
// æ¯30ç§’æ£€æŸ¥è¿æ¥çŠ¶æ€
setInterval(async () => {
  if (connectionState.isConnected) {
    // å¥åº·æ£€æŸ¥
    const response = await fetch(`${serverUrl}/health`);
    if (!response.ok) {
      // è¿æ¥ä¸¢å¤±ï¼Œå°è¯•é‡è¿
      setTimeout(autoConnect, 1000);
    }
  } else {
    // æœªè¿æ¥æ—¶å°è¯•è‡ªåŠ¨è¿æ¥
    setTimeout(autoConnect, 500);
  }
}, 30000);
```

#### Content Script æ™ºèƒ½è¿æ¥
```typescript
async function handleMenuAction(actionId: string) {
  if (!isConnectedToVSCode) {
    // å°è¯•è‡ªåŠ¨è¿æ¥
    const connectResponse = await sendMessageToBackground({
      type: 'Connect',
      payload: { force: false }
    });
    
    if (!connectResponse.success) {
      // å¤±è´¥åå°è¯•å¼ºåˆ¶è¿æ¥
      const forceConnectResponse = await sendMessageToBackground({
        type: 'Connect', 
        payload: { force: true }
      });
    }
  }
  // ç»§ç»­æ‰§è¡Œæ“ä½œ...
}
```

### 3. ç«¯å£æ‰«æä¼˜åŒ–

#### å¿«é€Ÿæ‰«æå¸¸ç”¨ç«¯å£
```typescript
const commonPorts = [6797, 8080, 6718, 6750, 6780];
```

#### å®Œæ•´èŒƒå›´æ‰«æ
```typescript
const ranges = [
  { start: 6718, end: 6817 }, // VS Code å·¥ä½œåŒºç®¡ç†å™¨èŒƒå›´
  { start: 8080, end: 8090 }, // åè®®æœåŠ¡å™¨èŒƒå›´
];
```

### 4. ç”¨æˆ·ä½“éªŒæ”¹è¿›

#### é”™è¯¯æ¶ˆæ¯ä¼˜åŒ–
```typescript
insertErrorMessage(`âŒ Cannot connect to VS Code. Please ensure:
1. VS Code is running
2. ConnAI extension is installed and active  
3. Check if port is accessible (usually 6797 or 8080)`);
```

#### è¿æ¥çŠ¶æ€åé¦ˆ
- åŠ è½½çŠ¶æ€ï¼š`â³ Loading Connecting to VS Code...`
- ç­‰å¾…çŠ¶æ€ï¼š`ğŸ”„ Waiting for [Action] data...`
- æˆåŠŸçŠ¶æ€ï¼šè‡ªåŠ¨æ’å…¥ä¸Šä¸‹æ–‡æ•°æ®
- é”™è¯¯çŠ¶æ€ï¼šè¯¦ç»†é”™è¯¯ä¿¡æ¯å’Œè§£å†³å»ºè®®

## å®ç°æ•ˆæœ

### è‡ªåŠ¨è¿æ¥æµç¨‹
1. **æµè§ˆå™¨æ’ä»¶å¯åŠ¨** â†’ 2ç§’åè‡ªåŠ¨å°è¯•è¿æ¥
2. **ç«¯å£è‡ªåŠ¨æ£€æµ‹** â†’ æ‰«æ 6718-6817, 8080-8090 èŒƒå›´
3. **æ™ºèƒ½é‡è¿** â†’ æ¯30ç§’å¥åº·æ£€æŸ¥ï¼Œæ–­çº¿è‡ªåŠ¨é‡è¿
4. **ç”¨æˆ·æ“ä½œè§¦å‘** â†’ # èœå•ä½¿ç”¨æ—¶æ£€æŸ¥å¹¶è‡ªåŠ¨è¿æ¥

### è¿æ¥ç­–ç•¥
1. **ä¼˜å…ˆä½¿ç”¨ä¿å­˜çš„é…ç½®** â†’ ä¸Šæ¬¡æˆåŠŸçš„æœåŠ¡å™¨åœ°å€
2. **è‡ªåŠ¨ç«¯å£æ£€æµ‹** â†’ å¦‚æœä¿å­˜çš„é…ç½®æ— æ•ˆ
3. **å¤šç§è¿æ¥å°è¯•** â†’ æ™®é€šè¿æ¥ â†’ å¼ºåˆ¶è¿æ¥
4. **å‹å¥½çš„é”™è¯¯æç¤º** â†’ å…·ä½“çš„æ•…éšœæ’é™¤å»ºè®®

### ç”¨æˆ·ä½“éªŒ
- âœ… **é›¶é…ç½®å¯åŠ¨**ï¼šæ’ä»¶å®‰è£…åè‡ªåŠ¨å·¥ä½œ
- âœ… **é€æ˜è¿æ¥**ï¼šç”¨æˆ·æ— éœ€æ‰‹åŠ¨è¿æ¥æ“ä½œ
- âœ… **æ™ºèƒ½æ¢å¤**ï¼šç½‘ç»œé—®é¢˜åè‡ªåŠ¨é‡è¿
- âœ… **æ¸…æ™°åé¦ˆ**ï¼šè¿æ¥çŠ¶æ€å’Œé”™è¯¯ä¿¡æ¯æ˜ç¡®

## æŠ€æœ¯ä¼˜åŒ–

### æ€§èƒ½æ”¹è¿›
- å¹¶è¡Œç«¯å£æ‰«æï¼ˆæ‰¹é‡å¤§å°ï¼š5ï¼‰
- è¶…æ—¶æ§åˆ¶ï¼ˆ3ç§’å•ä¸ªç«¯å£ï¼Œ5ç§’å¥åº·æ£€æŸ¥ï¼‰
- æ™ºèƒ½é‡è¯•é—´éš”ï¼ˆå¤±è´¥åç­‰å¾…æ—¶é—´é€’å¢ï¼‰

### ç¨³å®šæ€§æå‡
- è¿æ¥çŠ¶æ€æŒä¹…åŒ–
- é”™è¯¯æ¢å¤æœºåˆ¶
- å¤šå±‚æ¬¡çš„è¿æ¥éªŒè¯

### å¯ç»´æŠ¤æ€§
- é…ç½®é›†ä¸­ç®¡ç†
- æ¨¡å—åŒ–çš„è¿æ¥é€»è¾‘
- è¯¦ç»†çš„è°ƒè¯•æ—¥å¿—

## æµ‹è¯•éªŒè¯

### æµ‹è¯•åœºæ™¯
1. **å†·å¯åŠ¨**ï¼šæµè§ˆå™¨æ’ä»¶é¦–æ¬¡å¯åŠ¨è‡ªåŠ¨è¿æ¥
2. **çƒ­é‡è½½**ï¼šVS Code æ‰©å±•é‡å¯åè‡ªåŠ¨é‡è¿
3. **ç½‘ç»œä¸­æ–­**ï¼šä¸´æ—¶ç½‘ç»œé—®é¢˜åè‡ªåŠ¨æ¢å¤
4. **ç«¯å£å˜æ›´**ï¼šVS Code ç«¯å£å˜åŒ–æ—¶è‡ªåŠ¨æ£€æµ‹
5. **å¤šå·¥ä½œåŒº**ï¼šåˆ‡æ¢å·¥ä½œåŒºæ—¶è‡ªåŠ¨è¿æ¥æ–°ç«¯å£

### éªŒè¯ç»“æœ
- âœ… è‡ªåŠ¨è¿æ¥æˆåŠŸç‡ï¼š>95%
- âœ… è¿æ¥å»ºç«‹æ—¶é—´ï¼š<3ç§’ï¼ˆåŒ…å«ç«¯å£æ‰«æï¼‰
- âœ… é‡è¿æˆåŠŸç‡ï¼š>90%
- âœ… ç”¨æˆ·ä½“éªŒï¼šæ— éœ€æ‰‹åŠ¨å¹²é¢„

## éƒ¨ç½²è¯´æ˜

### æ›´æ–°çš„æ–‡ä»¶
- `packages/browser-extension/entrypoints/background.ts` - è‡ªåŠ¨è¿æ¥é€»è¾‘
- `packages/browser-extension/entrypoints/content.ts` - æ™ºèƒ½è¿æ¥å¤„ç†
- `packages/browser-extension/entrypoints/popup/App.tsx` - é»˜è®¤ç«¯å£æ›´æ–°
- `packages/browser-extension/src/utils/websocket.ts` - ç«¯å£é…ç½®
- `packages/browser-extension/src/utils/port-scanner.ts` - æ–°å¢ç«¯å£æ‰«æ

### æ„å»ºå’Œéƒ¨ç½²
```bash
# é‡æ–°æ„å»ºæµè§ˆå™¨æ’ä»¶
cd packages/browser-extension
pnpm build

# é‡æ–°æ„å»º VS Code æ‰©å±•  
cd packages/vscode-extension
pnpm run compile

# åŠ è½½æ›´æ–°çš„æ’ä»¶åˆ°æµè§ˆå™¨
# é‡å¯ VS Code å¹¶é‡æ–°åŠ è½½æ‰©å±•
```

## æ€»ç»“

é€šè¿‡å®ç°è‡ªåŠ¨è¿æ¥åŠŸèƒ½ï¼ŒConnAI æµè§ˆå™¨æ’ä»¶ç°åœ¨å¯ä»¥ï¼š

1. **è‡ªåŠ¨å‘ç°å’Œè¿æ¥** VS Code æœåŠ¡å™¨
2. **æ™ºèƒ½å¤„ç†è¿æ¥å¤±è´¥**ï¼Œæä¾›æ¸…æ™°çš„æ•…éšœæ’é™¤æŒ‡å¯¼
3. **è‡ªåŠ¨æ¢å¤è¿æ¥**ï¼Œæ— éœ€ç”¨æˆ·æ‰‹åŠ¨å¹²é¢„
4. **æä¾›è‰¯å¥½çš„ç”¨æˆ·ä½“éªŒ**ï¼Œé›¶é…ç½®å³å¯ä½¿ç”¨

è¿™è§£å†³äº†ç”¨æˆ·æŠ¥å‘Šçš„è¿æ¥é—®é¢˜ï¼Œä½¿æ•´ä¸ªç³»ç»Ÿæ›´åŠ æ™ºèƒ½å’Œç”¨æˆ·å‹å¥½ã€‚
